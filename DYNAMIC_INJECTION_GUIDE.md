# 动态记忆注入与常识库系统

## 概述

本次更新实现了两个主要功能：
1. **动态记忆注入系统** - 类似CharacterAI/酒馆的智能记忆选择
2. **通用常识库** - 可自定义的世界观/背景知识管理系统

---

## 🎯 动态记忆注入系统

### 特性

#### 智能评分机制
动态注入系统会根据多个维度对记忆进行评分：

1. **时间衰减 (30%)** - 越新的记忆权重越高
   - 使用指数衰减函数，半衰期为1天（游戏时间）
   
2. **重要性 (30%)** - 记忆本身的重要性分数
   - 由事件类型、用户编辑等因素决定
   
3. **关键词匹配 (40%)** - 与当前对话上下文的相关度
   - 使用Jaccard相似度算法
   - 同时检查内容直接匹配

4. **额外加成**
   - 层级加成：ABM(100%) > SCM(70%) > ELS(40%) > CLPA(20%)
   - 固定记忆：+50%
   - 用户编辑：+30%
   - 活跃度：+10%

#### 工作流程

```
1. 提取对话上下文关键词（2-4字词语，最多20个）
2. 收集所有记忆层级的记忆
3. 计算每条记忆的评分
4. 按评分排序，选取Top N条
5. 格式化并注入到提示词中
```

### 配置选项

在Mod设置中可以配置：

- **启用动态注入** (默认：开启)
- **最大注入记忆数** (默认：10条，范围5-20)
- **最大注入常识数** (默认：5条，范围3-10)
- **评分权重**
  - 时间衰减权重 (默认：30%)
  - 重要性权重 (默认：30%)
  - 关键词匹配权重 (默认：40%)

### 注入格式

动态注入的记忆会以如下格式出现在提示词中：

```markdown
## 角色记忆

### 当前状态
- [对话] 与John谈论了食物 (刚才)

### 近期经历
- [行动] 完成了建造工作 (2小时前)
- [事件] 遭遇袭击并击退敌人 (5小时前)

### 重要事件
- [对话] 与Mary深入讨论了未来计划 (1天前)
```

---

## 📚 常识库系统

### 特性

#### 数据格式
常识库使用简单的纯文本格式：

```
[标签]内容
[标签]内容
```

示例：
```
[世界观]这是一个末日后的边缘星球，殖民者正在努力生存
[规则]殖民者需要食物、休息和娱乐来维持心理健康
[历史]殖民地建立于5505年，已经存在了3年
```

#### 动态注入
常识库会根据对话上下文智能选择最相关的常识条目：

1. 提取上下文关键词
2. 计算每条常识的相关性分数
   - 关键词匹配（Jaccard相似度）
   - 标签匹配
   - 重要性权重
3. 选择Top N条注入

#### 注入格式

```markdown
## 背景常识

- [世界观] 这是一个末日后的边缘星球，殖民者正在努力生存
- [规则] 殖民者需要食物、休息和娱乐来维持心理健康
```

### 常识库管理界面

#### 打开方式
1. 进入游戏
2. 打开Mod设置
3. 点击"常识库"部分的"打开常识库管理"按钮

#### 功能

##### 1. 新建
- 手动创建新的常识条目
- 可设置标签、内容、重要性

##### 2. 导入
支持两种导入方式：

**方式A：直接粘贴**
1. 点击"导入"按钮
2. 在弹出窗口中粘贴文本
3. 格式：`[标签]内容`，每行一条

**方式B：从文件导入**
1. 准备txt文件，格式同上
2. 手动复制内容到导入窗口

##### 3. 导出
- 点击"导出"按钮
- 自动保存到：`SaveData/CommonKnowledge_日期时间.txt`
- 自动打开SaveData文件夹

##### 4. 编辑
- 选中条目后点击"编辑"
- 可修改标签、内容、重要性
- 可启用/禁用条目

##### 5. 删除
- 选中条目后点击"删除"
- 需要确认

##### 6. 清空全部
- 一键清空所有常识
- 需要确认
- **警告：此操作不可撤销！**

#### 界面功能

- **搜索框** - 按标签或内容过滤
- **统计信息** - 显示总数和启用数量
- **复选框** - 快速启用/禁用条目
- **详情面板** - 显示完整信息
  - 标签
  - 重要性
  - 关键词
  - 完整内容

---

## 🔧 技术实现

### 文件结构

```
Source/Memory/
├── DynamicMemoryInjection.cs      # 动态注入系统
├── CommonKnowledgeLibrary.cs      # 常识库数据结构
├── MemoryManager.cs                # WorldComponent（已更新）
└── UI/
    └── Dialog_CommonKnowledge.cs   # 常识库管理界面
```

### API接口

#### 1. 动态注入记忆
```csharp
string memoryContext = DynamicMemoryInjection.InjectMemories(
    pawn,              // 目标小人
    context,           // 对话上下文
    maxMemories: 10    // 最大记忆数
);
```

#### 2. 注入常识
```csharp
var memoryManager = Find.World.GetComponent<MemoryManager>();
string knowledgeContext = memoryManager.CommonKnowledge.InjectKnowledge(
    context,           // 对话上下文
    maxEntries: 5      // 最大常识数
);
```

#### 3. RimTalk集成
系统会自动patch以下RimTalk方法：
- `PromptService.BuildContext` (Postfix)
- `PromptService.DecoratePrompt` (Postfix)
- `TalkService.GenerateTalk` (Prefix)

---

## 📊 性能优化

### 关键词提取优化
- 简单的中文分词（2-4字）
- 限制关键词数量（最多20个）
- 缓存提取结果

### 评分计算优化
- 使用预计算的权重
- 早期过滤低分记忆
- 限制检索数量

### 内存管理
- 常识库使用惰性加载
- 自动清理过期缓存
- 限制单次注入数量

---

## 🎮 使用建议

### 记忆注入配置

**对话频繁的场景**（如日常闲聊）
- 最大记忆数：5-8条
- 时间衰减权重：40%+
- 关键词匹配权重：30%

**剧情重要的场景**（如重要决策）
- 最大记忆数：10-15条
- 重要性权重：40%+
- 包含归档记忆

### 常识库设计

**世界观常识**
```
[世界观]这是一个末日后的世界
[世界观]科技水平相当于21世纪初期
[背景]殖民地名为"新希望"
```

**规则常识**
```
[规则]殖民者需要定期休息
[规则]极端天气会影响心情
[规则]资源有限需要合理分配
```

**角色设定**（如果使用固定角色）
```
[性格]John是一个乐观的建筑师
[性格]Mary是谨慎的医生
[关系]John和Mary是老朋友
```

---

## 🐛 已知问题

1. **中文分词不够精确**
   - 当前使用简单的N-gram分词
   - 建议：标签使用明确的2-4字词语

2. **性能考虑**
   - 常识库条目建议不超过100条
   - 单条内容建议不超过200字

---

## 🔄 与旧系统的兼容性

### 自动兼容
- 如果关闭动态注入，会自动回退到静态注入（GetMemoryContext）
- 所有现有的记忆数据完全兼容
- PawnMemoryComp API保持不变

### 迁移建议
1. 先在新存档测试动态注入
2. 确认效果满意后在旧存档启用
3. 可随时切换回静态注入

---

## 📝 更新日志

### v2.0 - 动态注入系统
- ✅ 实现动态记忆注入
- ✅ 实现常识库系统
- ✅ 添加常识库管理界面
- ✅ 支持导入/导出
- ✅ 完整的评分系统
- ✅ 与RimTalk无缝集成

---

## 🙏 致谢

- 动态注入灵感来自 CharacterAI 和 SillyTavern
- 评分算法参考了信息检索领域的相关研究
