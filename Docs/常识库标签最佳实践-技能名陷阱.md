# 常识库标签最佳实践 - 技能名陷阱

## ?? 重要发现

在 RimTalk 的匹配逻辑中，**技能名称**（如"射击"、"近战"、"建造"）**不能作为单独的标签使用**，否则会导致频繁的误触发。

## 问题根源

### 匹配文本的构成

RimTalk 在匹配常识时，会构建一个包含以下内容的匹配文本：

```
[对话内容] + [Pawn基本信息] + [Pawn技能信息]
```

**代码实现**（`CommonKnowledgeLibrary.cs` 的 `BuildPawnInfoText` 方法）：

```csharp
private string BuildPawnInfoText(Verse.Pawn pawn)
{
    var sb = new StringBuilder();
    
    // 1. 名字
    sb.Append(pawn.Name.ToStringShort);
    sb.Append(" ");
    
    // 2. 性别
    sb.Append(pawn.gender.GetLabel());
    sb.Append(" ");
    
    // 3. 种族
    sb.Append(pawn.def.label);
    sb.Append(" ");
    
    // 4. 特性（最多5个）
    foreach (var trait in pawn.story.traits.allTraits)
    {
        sb.Append(trait.def.label);
        sb.Append(" ");
    }
    
    // 5. ?? 10级以上的技能名称
    foreach (var skillRecord in pawn.skills.skills)
    {
        if (skillRecord.Level < 10) continue;
        
        sb.Append(skillRecord.def.label);  // "射击"、"近战"、"建造" 等
        sb.Append(" ");
    }
    
    return sb.ToString();
}
```

### 实际匹配文本示例

假设有一个叫"张三"的殖民者，她是：
- 女性人类
- 特性：工作狂、乐观
- 技能：射击 15级、近战 12级、建造 11级

当她说"今天天气不错"时，构建的匹配文本会是：

```
今天天气不错 张三 女性 人类 工作狂 乐观 射击 近战 建造
```

## 问题演示

### ? 错误用法

```
标签: [射击]
内容: 射击战斗规则：瞄准时保持稳定，射击距离越远精准度越低...
```

**问题**：
- 张三的**所有对话**都会包含"射击"（因为她射击技能≥10）
- 即使在讨论烹饪、园艺、睡觉，`[射击]` 常识也会被触发
- 导致无关的战斗规则频繁注入对话

### 示例场景

| 对话内容 | 匹配文本 | `[射击]` 是否匹配 | 合理性 |
|---------|---------|-----------------|--------|
| "我去练习射击" | "我去练习射击 张三 女性 人类 射击 近战 建造" | ? 匹配 | ? 合理 |
| "今天要做饭" | "今天要做饭 张三 女性 人类 射击 近战 建造" | ? 匹配 | ? **不合理** |
| "我要睡觉了" | "我要睡觉了 张三 女性 人类 射击 近战 建造" | ? 匹配 | ? **不合理** |
| "帮我建造墙壁" | "帮我建造墙壁 张三 女性 人类 射击 近战 建造" | ? 匹配 | ? **不合理**（虽然提到建造，但常识是关于射击的）|

## 解决方案

### ? 正确用法 1：组合标签

使用**更具体的语境关键词**，而不是单纯的技能名：

```
标签: [规则-射击战斗,瞄准,精准]
内容: 射击战斗规则：瞄准时保持稳定，射击距离越远精准度越低...
```

**效果**：
- 只有当对话**明确提到**"瞄准"或"精准"时才触发
- 避免在无关对话中误触

### ? 正确用法 2：多关键词组合

```
标签: [战斗技巧,远程攻击,掩体,射程]
内容: 远程战斗时应利用掩体，注意射程限制...
```

### ? 正确用法 3：场景化标签

```
标签: [规则-战斗准备,弹药检查]
内容: 战斗前检查弹药储备，确保武器已装填...
```

## 其他易误触的单标签

以下技能名称作为单标签都会导致类似问题：

| 技能名 | 问题 | 推荐标签 |
|-------|------|---------|
| `[射击]` | 所有射击专家的对话都触发 | `[规则-射击战斗,瞄准]` |
| `[近战]` | 所有近战专家的对话都触发 | `[技巧-近战,格挡]` |
| `[建造]` | 所有建筑师的对话都触发 | `[规则-建造,蓝图]` |
| `[烹饪]` | 所有厨师的对话都触发 | `[技巧-烹饪,食材]` |
| `[医疗]` | 所有医生的对话都触发 | `[规则-医疗,治疗]` |
| `[种植]` | 所有农民的对话都触发 | `[技巧-种植,播种]` |
| `[研究]` | 所有研究员的对话都触发 | `[规则-研究,科技树]` |
| `[社交]` | 所有社交专家的对话都触发 | `[技巧-外交,谈判]` |

## 标签设计原则

### 1. **避免单一技能名**
- ? `[射击]`
- ? `[规则-射击战斗,瞄准]`

### 2. **添加语境关键词**
- ? `[战斗]`（太宽泛）
- ? `[战斗,掩体,战术]`

### 3. **使用分层标签**
- ? `[规则-射击]` + `[技巧-射击]` + `[战术-远程]`
- 通过分类前缀区分用途

### 4. **测试标签匹配范围**
使用常识库预览器测试：
1. 打开常识库管理界面
2. 输入测试对话
3. 查看哪些常识被匹配
4. 调整标签直到匹配符合预期

## 标签长度建议总结

根据匹配逻辑的特点，推荐的标签长度和格式：

| 标签类型 | 推荐长度 | 示例 | 说明 |
|---------|---------|------|------|
| 单关键词 | ≥ 3字 | `[环世界]`、`[殖民地规则]` | 避免误触 |
| 组合标签 | 2-3个关键词 | `[战斗,掩体,战术]` | 提高精确度 |
| 分层标签 | 前缀+关键词 | `[规则-射击,瞄准]` | 分类清晰 |
| 场景标签 | 场景+动作 | `[战斗准备,弹药检查]` | 语境明确 |

## 实战示例

### 场景：为射击专家创建战斗规则

#### ? 错误方案

```
[射击|0.8]射击战斗时保持稳定，控制呼吸，瞄准敌人弱点。
```

**问题**：射击专家的**所有对话**都会注入这条常识。

#### ? 正确方案 1：添加触发词

```
[规则-射击战斗,瞄准,精准|0.8]射击战斗时保持稳定，控制呼吸，瞄准敌人弱点。
```

**效果**：只在讨论"瞄准"或"精准"相关话题时触发。

#### ? 正确方案 2：多条精确常识

```
[规则-战斗,瞄准|0.8]瞄准时保持稳定，控制呼吸。
[规则-战斗,精准度|0.7]射击距离越远精准度越低，选择合适交战距离。
[规则-战斗,掩体|0.8]使用掩体可以大幅提高生存率。
[战术-远程攻击,射程|0.7]注意武器的有效射程，超出射程会显著降低命中率。
```

**效果**：每条常识都有明确的触发场景，避免泛滥。

## 总结

1. **永远不要使用单一技能名作为标签**（如 `[射击]`、`[近战]`）
2. **匹配文本包含Pawn的10级以上技能**，导致技能名会频繁出现
3. **使用组合标签和语境关键词**（如 `[规则-射击战斗,瞄准]`）
4. **标签长度建议≥3字**，或使用2-3个关键词组合
5. **分层标签**可以同时保持分类清晰和触发精确

---

**更新日期**: 2025-12-20  
**版本**: v3.3.21+  
**相关文档**: [常识库使用说明按钮](./常识库使用说明按钮.md)
