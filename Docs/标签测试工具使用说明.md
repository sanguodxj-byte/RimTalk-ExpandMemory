# 标签测试工具使用说明

## 功能概述

**标签测试工具** 是一个独立的弹窗工具，帮助用户验证标签是否能够正确匹配对话内容。

## 位置

**常识库界面** → **左侧边栏** → **?? 标签测试** 按钮（浅绿色）

点击后会弹出独立的测试窗口。

## 功能特性

### ?? 实时测试
- 无需创建真实常识条目
- 即时反馈匹配结果
- 显示实际匹配文本

### ?? Pawn 信息模拟
- 可选择当前地图的任意 Pawn
- 自动包含 Pawn 的技能、特性等信息
- 真实还原匹配场景

### ?? 详细日志
- 在游戏日志中输出完整匹配信息
- 包含标签、对话、Pawn、匹配文本、结果

### ?? 清晰的布局
- 上半部分：输入区域（标签、对话、Pawn选择）
- 分隔线
- 下半部分：结果显示区域（完全独立，不重叠）
- 可滚动的匹配文本显示
- 窗口尺寸：650x600 像素

## 使用步骤

### 1. 打开标签测试工具

1. 打开常识库管理界面（Mod 设置 → 常识库）
2. 在左侧边栏找到 **?? 标签测试** 按钮（浅绿色）
3. 点击打开独立测试窗口

### 2. 输入测试数据

**测试标签**：
- 输入你想测试的标签
- 支持逗号分隔的多个标签
- 示例：`战斗,射击,瞄准`

**对话内容**：
- 输入模拟的对话文本
- 支持多行输入
- 示例：`我去练习射击技术`

**选择 Pawn**（可选）：
- 点击下拉菜单选择 Pawn
- 或选择"无（仅对话内容）"仅测试对话
- 选择 Pawn 后会自动添加其技能、特性等信息

### 3. 执行测试

点击 **?? 测试** 按钮，工具会：

1. 构建完整的匹配文本
   - 对话内容 + Pawn 基本信息 + Pawn 技能（≥10级）

2. 测试标签是否匹配

3. 显示结果：
   - ? **匹配成功**（绿色）
   - ? **不匹配**（红色）

4. 在游戏日志输出详细信息

### 4. 查看详细结果

按 <kbd>F12</kbd> 打开游戏日志，查看详细匹配信息：

```
[标签测试] 标签: 战斗,射击,瞄准
[标签测试] 对话: 我去练习射击技术
[标签测试] Pawn: 张三
[标签测试] 实际匹配文本: 我去练习射击技术 张三 女性 人类 工作狂 射击 近战 建造
[标签测试] 结果: 匹配成功
```

## 使用场景

### 场景1：测试新标签是否有效

**问题**：不确定 `[规则-战斗系统]` 是否能在战斗对话中触发

**测试**：
1. 测试标签：`规则-战斗系统`
2. 对话内容：`敌人来袭，准备战斗`
3. 选择 Pawn：任意殖民者
4. 结果：? 不匹配

**原因**：对话中没有包含"规则-战斗系统"这个完整字符串

**解决**：使用 `[战斗,敌人,袭击]` 或 `[规则-战斗,敌人]`

### 场景2：诊断技能名误触

**问题**：`[射击]` 标签总是被触发，即使在谈论烹饪

**测试**：
1. 测试标签：`射击`
2. 对话内容：`今天我要做饭`
3. 选择 Pawn：张三（射击技能 15 级）
4. 查看日志：
   ```
   实际匹配文本: 今天我要做饭 张三 女性 人类 射击 近战 建造
   ```
5. 结果：? 匹配成功

**原因**：张三的射击技能 ≥10 级，自动添加到匹配文本中

**解决**：使用 `[规则-射击战斗,瞄准,精准]`

### 场景3：验证组合标签

**问题**：使用组合标签 `[战斗,瞄准,射击]` 是否合理

**测试1**：
- 对话：`我要练习瞄准`
- Pawn：无
- 结果：? 匹配（包含"瞄准"）

**测试2**：
- 对话：`今天天气不错`
- Pawn：张三（射击 15 级）
- 结果：? 匹配（Pawn 信息包含"射击"）

**结论**：组合标签仍会因 Pawn 技能而误触，需要更精确

**改进**：使用 `[战斗技巧,瞄准训练]`

## 最佳实践

### ? 推荐的测试流程

1. **先测试无 Pawn 场景**
   - 只使用对话内容
   - 验证标签是否与对话直接相关

2. **再测试有 Pawn 场景**
   - 选择不同技能的 Pawn
   - 检查是否会因技能名误触

3. **测试边界情况**
   - 测试对话中没有标签关键词的情况
   - 测试 Pawn 技能包含标签关键词的情况

### ? 常见误区

**误区1**：只测试理想场景
```
? 只测试：对话="我要射击" → 匹配
? 也要测试：对话="我要睡觉" + Pawn射击技能 → 是否误触？
```

**误区2**：忽略 Pawn 技能影响
```
? 认为：标签 [建造] 只在讨论建造时触发
? 实际：任何建造专家（≥10级）的对话都会触发
```

**误区3**：不查看日志详情
```
? 只看：? 匹配 / ? 不匹配
? 查看：实际匹配文本包含了什么
```

## 技术细节

### 匹配逻辑

工具使用与常识库完全相同的匹配逻辑：

```csharp
// 1. 构建匹配文本
matchText = 对话内容 + " " + Pawn名字 + " " + 性别 + " " + 种族 + 
            " " + 特性列表 + " " + 技能列表（≥10级）

// 2. 标签匹配（Any 模式）
foreach (var tag in tags)
{
    if (matchText.Contains(tag, 忽略大小写))
        return 匹配成功;
}
return 不匹配;
```

### Pawn 信息包含内容

当选择 Pawn 时，会添加以下信息到匹配文本：

1. **名字**：Pawn.Name.ToStringShort
2. **性别**：男性 / 女性
3. **种族**：人类 / 其他种族
4. **特性**：最多 5 个特性标签
5. **技能**：等级 ≥ 10 的所有技能名称

**示例**：
```
张三 女性 人类 工作狂 乐观 射击 近战 建造
```

### 匹配模式

当前工具使用 **Any 模式**（默认）：
- 只要匹配文本包含任意一个标签即算匹配
- 与常识库的 Any 模式一致

未来可能支持 All 模式测试。

## 故障排除

### 问题1：结果与实际不符

**症状**：测试显示匹配，但游戏中不触发

**原因**：
- 常识条目被禁用
- 重要性太低被排除
- 达到最大注入数量限制

**解决**：
- 检查常识是否启用
- 提高重要性
- 增加最大注入数量设置

### 问题2：无法选择 Pawn

**症状**：Pawn 列表为空

**原因**：
- 未进入游戏
- 当前地图没有 Pawn

**解决**：
- 加载存档
- 进入游戏地图

### 问题3：日志信息不显示

**症状**：点击测试后没有日志输出

**原因**：
- 游戏日志窗口未打开
- 日志级别过滤

**解决**：
- 按 <kbd>F12</kbd> 打开日志
- 搜索 "[标签测试]"
