# 修复：提示词花括号导致的格式化错误

## ?? 问题描述

用户报告：**总结提示词内有json格式符的花括号会导致报错**

当用户在自定义提示词（每日总结或深度归档）中使用花括号 `{}` 时（例如JSON格式或其他占位符），会导致 `string.Format` 抛出格式化异常。

### 错误示例

用户自定义提示词：
```
殖民者{0}的记忆归档

请将以下记忆整理成JSON格式：
{
  "summary": "总结内容",
  "events": []
}

记忆列表：
{1}
```

当执行 `string.Format(promptTemplate, pawn.LabelShort, memoryList)` 时会报错，因为 `string.Format` 会尝试解析花括号。

---

## ? 修复方案

### 修改文件
- `Source/Memory/AI/IndependentAISummarizer.cs`

### 修改内容

在 `BuildPrompt` 方法中，添加花括号转义逻辑：

```csharp
// ? 修复：先转义花括号，防止 string.Format 报错
// 将用户自定义提示词中的 { 和 } 转义为 {{ 和 }}
string escapedTemplate = promptTemplate.Replace("{", "{{").Replace("}", "}}");

// 然后把占位符 {{0}} 和 {{1}} 替换回 {0} 和 {1}
escapedTemplate = escapedTemplate.Replace("{{0}}", "{0}").Replace("{{1}}", "{1}");

// 替换占位符
string result = string.Format(escapedTemplate, pawn.LabelShort, memoryList);
```

### 工作原理

1. **第一步**：将所有花括号转义
   - `{` → `{{`
   - `}` → `}}`

2. **第二步**：恢复占位符
   - `{{0}}` → `{0}` （殖民者名称占位符）
   - `{{1}}` → `{1}` （记忆列表占位符）

3. **第三步**：安全执行 `string.Format`

---

## ?? 测试场景

### 场景1：默认提示词（无花括号）
**输入：**
```
殖民者{0}的记忆总结

记忆列表
{1}

要求提炼地点人物事件
```

**输出：**
```
殖民者约翰的记忆总结

记忆列表
1. 今天与玛丽对话
2. 昨天建造了墙壁

要求提炼地点人物事件
```

? **结果**：正常工作

---

### 场景2：自定义提示词（包含花括号）
**输入：**
```
殖民者{0}的记忆归档

请整理成JSON格式：
{
  "summary": "简要总结",
  "details": {
    "events": []
  }
}

记忆列表：
{1}
```

**修复前**：? 报错 `FormatException: Input string was not in a correct format`

**修复后**：? 正常输出
```
殖民者约翰的记忆归档

请整理成JSON格式：
{
  "summary": "简要总结",
  "details": {
    "events": []
  }
}

记忆列表：
1. 今天与玛丽对话
2. 昨天建造了墙壁
```

---

## ?? 编译状态

```bash
dotnet build --configuration Release

结果：
? 0 个错误
??  9 个警告（无关紧要）
```

---

## ?? 影响范围

### 受益用户
- 使用自定义提示词的用户
- 需要结构化输出（JSON/YAML等）的用户
- 使用第三方AI模型特殊格式要求的用户

### 兼容性
- ? 向后兼容：默认提示词不受影响
- ? 现有自定义提示词（不含花括号）继续正常工作
- ? 新的自定义提示词可以自由使用花括号

---

## ?? 用户指南

### 如何使用自定义提示词中的花括号

现在您可以在自定义提示词中自由使用花括号，例如：

#### JSON 格式化输出
```
殖民者{0}的记忆分析

请输出JSON格式：
{
  "pawn": "{0}",
  "memory_count": 5,
  "categories": {
    "social": [],
    "work": []
  }
}

记忆内容：
{1}
```

#### 多语言占位符
```
Colonist {0}'s memory summary

Format: {time} | {location} | {activity}

Memories:
{1}
```

#### 结构化模板
```
记忆报告 - {0}

[基本信息]
- 姓名: {0}
- 状态: { "active": true }

[记忆列表]
{1}
```

---

## ?? 版本信息

- **修复版本**: v3.3.2.37
- **修复日期**: 2024-12-25
- **修复内容**: 提示词花括号转义支持

---

## ?? 相关问题

### Q1: 为什么不直接使用 `$""` 字符串插值？

**A**: 因为我们需要支持用户自定义提示词模板，这些模板存储在配置文件中，运行时才动态替换占位符。字符串插值只能用于编译时已知的字符串。

### Q2: 如果用户真的需要输出 `{{0}}` 怎么办？

**A**: 用户可以在提示词中使用四个花括号 `{{{{0}}}}` 来实现。经过转义后会变成 `{{0}}`（显示为两个花括号+占位符）。

### Q3: 这个修复会影响性能吗？

**A**: 不会。字符串替换操作是 O(n)，对于几百字符的提示词模板来说几乎没有性能影响（<1ms）。

---

## ? 测试建议

1. **测试默认提示词**
   - 验证每日总结和深度归档正常工作

2. **测试自定义提示词（含花括号）**
   - 在设置中添加包含 `{}` 的自定义提示词
   - 触发总结功能，验证不会报错

3. **测试占位符替换**
   - 验证 `{0}` 被正确替换为殖民者名称
   - 验证 `{1}` 被正确替换为记忆列表

---

**修复完成！用户现在可以在自定义提示词中自由使用花括号了。** ??
