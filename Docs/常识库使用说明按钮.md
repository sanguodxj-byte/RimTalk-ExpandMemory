# 常识库使用说明按钮功能说明

## 更新内容

为常识库界面添加了**使用说明按钮**和**标签测试工具**，帮助用户更好地理解和使用常识库功能。

## ? v3 更新 - 添加标签测试工具

**新增交互式标签测试工具**，让用户可以实时验证标签匹配效果：

### 功能特性
- ?? **实时测试**：无需创建真实条目，即时反馈
- ?? **Pawn 模拟**：可选择任意 Pawn，真实还原匹配场景
- ?? **详细日志**：在游戏日志中输出完整匹配信息
- ?? **可折叠界面**：不占用空间，需要时展开

### 工具位置
- **常识库界面** → **左侧边栏** → **?? 标签测试**
- 位于使用说明按钮上方
- 浅绿色按钮，易于识别

### 使用场景
1. **测试新标签**：验证 `[战斗,射击]` 是否会在正确场景触发
2. **诊断误触**：检查 `[射击]` 为什么总是被触发
3. **优化标签**：对比不同标签组合的匹配效果

### 详细文档
查看 [标签测试工具使用说明](./标签测试工具使用说明.md)

## ? v2 更新 - 添加标签长度警告

根据实际匹配逻辑分析，增加了关于**避免过短标签**的重要提示：

### 匹配逻辑分析
- 当前使用 `IndexOf` 子字符串匹配（不区分大小写）
- **短标签（1-2字）容易误触**
  - `[星]` 会匹配："火星"、"星际"、"星期"等
  - `[人]` 会匹配："人类"、"个人"、"人工智能"等
  - `[战]` 会匹配："战斗"、"战争"、"挑战"等

### 新增建议内容
1. **标签长度建议**
   - ? 推荐：3字以上的组合标签（如 `[世界观-星球]`、`[规则-战斗系统]`）
   - ? 避免：1-2字简短标签（如 `[星]`、`[人]`）

2. **使用组合标签提高精确度**
   - ? 好：`[世界观-环世界]` 或 `[角色-张三-背景]`
   - ? 差：`[张三]`（可能误触其他包含这个名字的对话）

3. **新增常见问题**
   - Q: 为什么我的常识总是被注入（过于频繁）？
   - A: 标签可能过短或过于宽泛。建议使用3字以上的组合标签

## 问题修复历史

### v1（初始版本）
- ? 添加了帮助按钮和基础说明内容
- ?? 翻译文件缺少内容（已修复）

### v2（当前版本）
- ? 修复了翻译文件缺失问题
- ? 添加了标签长度和格式的最佳实践
- ? 添加了关于子字符串匹配的技术说明
- ? 增加了误触问题的FAQ

## 功能位置

使用说明按钮位于：
- **常识库界面** → **左侧边栏** → **底部（统计信息上方）**
- 按钮文本：?? 使用说明
- 按钮颜色：浅蓝色 `Color(0.4f, 0.7f, 1f)`，易于识别

## 说明内容

点击按钮后，会弹出一个帮助对话框，包含以下内容：

### 1. 常识检索逻辑
详细说明了常识库如何在AI对话时自动注入相关内容：
- **关键词匹配**：从对话上下文中提取关键词匹配常识标签
  - Any模式：命中任一关键词即匹配
  - All模式：必须命中所有关键词才匹配
  - ?? **使用子字符串匹配（不区分大小写）**
  
- **向量相似度匹配**：使用语义相似度算法（需启用向量服务）
  - 即使关键词不完全一致，也能找到语义相关的内容
  
- **重要性排序**：按重要性(0.0-1.0)降序排列，只注入前N条最重要的常识

### 2. 如何编写有效的常识
提供了实用的编写指导：

? **标签要简洁明确，但避免过短**（? 新增）
- 好：`[世界观-星球]` 或 `[规则-战斗系统]`（3字以上）
- 差：`[星]` 或 `[人]`（1-2字，易误触）
- 说明：短标签会匹配到很多无关内容

? **使用组合标签提高精确度**（? 新增）
- 好：`[世界观-环世界]` 或 `[角色-张三-背景]`
- 差：`[张三]`（可能误触其他包含这个名字的对话）

? **内容要具体可用**
- 好：该星球是一颗环世界，重力为地球的0.8倍
- 差：这个星球很特别

? **合理设置重要性**
- 核心设定/规则：0.8-1.0
- 一般背景信息：0.5-0.7
- 次要细节：0.3-0.5

? **善用扩展属性**
- 允许匹配：开启后会参与关键词/向量检索
- 允许提取：开启后可被常识链功能引用

### 3. 常见问题

**Q: 为什么我的常识总是被注入（过于频繁）？**（? 新增）
- A: 标签可能过短或过于宽泛。建议使用3字以上的组合标签，如`[世界观-殖民地历史]`而不是`[历史]`

**Q: 为什么我的常识没有被注入？**
- A: 检查常识是否启用、匹配模式是否正确、重要性是否太低、标签是否与对话内容相关

**Q: 如何让AI只在特定场景使用某些常识？**
- A: 使用精确的组合标签（如`[规则-战斗-远程武器]`），并设置适中的重要性

## 技术实现

### 修改的文件
1. **CommonKnowledgeTranslationKeys.cs**
   ```csharp
   public const string Help = "RimTalk_Knowledge_Help";
   public const string HelpTitle = "RimTalk_Knowledge_HelpTitle";
   public const string HelpContent = "RimTalk_Knowledge_HelpContent";
   ```

2. **Dialog_CommonKnowledge.cs**
   - 在 `DrawSidebar()` 方法中添加帮助按钮
   - 实现 `ShowHelpDialog()` 方法显示帮助内容

3. **翻译文件**（v2 更新）
   - `Languages/ChineseSimplified/Keyed/RimTalk_CommonKnowledge.xml`
   - `Languages/English/Keyed/RimTalk_CommonKnowledge.xml`
   - 添加了标签长度警告和组合标签建议
   - 增加了关于误触的FAQ

### 代码特点
- 按钮位置：`innerRect.yMax - 100f`（为统计信息留出60px + 间距）
- 按钮颜色：浅蓝色突出显示
- 使用??图标增强视觉识别
- 帮助内容完全支持中英文双语
- 内容简洁易懂，采用问答和示例格式
- **特别强调了子字符串匹配的特性和潜在问题**

## 示例对比

### ? 容易误触的标签
```
[星]        → 匹配 "火星"、"星际"、"星期"、"星空"
[人]        → 匹配 "人类"、"个人"、"人工智能"、"敌人"
[战]        → 匹配 "战斗"、"战争"、"挑战"、"决战"
[规则]      → 匹配 "规则"、"潜规则"、"不规则"
```

### ? 推荐的标签格式
```
[世界观-星球]           → 精确匹配世界观相关的星球信息
[规则-战斗系统]         → 只在讨论战斗系统时匹配
[角色-张三-背景]        → 专门针对张三这个角色的背景设定
[世界观-环世界-重力]    → 非常精确的组合标签
```

## 测试步骤

1. 启动 RimWorld
2. 加载游戏存档
3. 打开 RimTalk Mod 设置
4. 点击"常识库"按钮
5. 在左侧边栏底部找到 **?? 使用说明** 按钮
6. 点击按钮查看帮助对话框
7. 验证以下内容：
   - ? 按钮显示正确（带图标和文本）
   - ? 按钮颜色为浅蓝色
   - ? 点击后弹出对话框
   - ? 对话框标题为"常识库使用指南"
   - ? 对话框内容包含：检索逻辑、编写指导（含标签长度建议）、常见问题
   - ? 内容格式正确，易于阅读
   - ? 特别提到了子字符串匹配和标签长度问题
8. 找到左侧边栏的 **?? 标签测试** 按钮
9. 点击按钮打开标签测试工具
10. 验证以下内容：
    - ? 工具显示正确
    - ? 可选择不同的 Pawn 进行测试
    - ? 实时输入标签并查看匹配结果
    - ? 日志中输出详细的匹配信息
    - ? 可折叠界面正常工作

## 部署状态

? **v2 已完成部署**
- 编译成功（0错误，0警告）
- 已部署到：`D:\steam\steamapps\common\RimWorld\Mods\RimTalk-ExpandMemory`
- 翻译文件已验证包含完整的帮助内容
- 已添加标签长度和匹配逻辑的详细说明

## 用户体验
- **易于发现**：按钮位置醒目，颜色突出
- **即时帮助**：一键打开说明，无需查阅外部文档
- **实用指导**：提供具体的使用建议和最佳实践
- **问题预防**：**特别警告了短标签的误触问题**
- **双语支持**：中英文完整翻译

---

**版本**: v3.3.21+ (v2)
**更新日期**: 2025-12-20
**状态**: ? 已修复并部署（含标签长度建议）
