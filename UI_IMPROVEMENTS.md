# UI改进说明 - 可折叠设置界面

## 变更内容

### 1. 设置界面添加可折叠功能

所有大型设置区块现在都可以折叠/展开，使界面更加整洁：

#### 可折叠的区块

1. **动态注入系统** - 默认展开 ✅
   - 启用/禁用动态注入
   - 注入数量配置
   - 评分权重配置

2. **四层记忆容量** - 默认折叠
   - ABM、SCM、ELS容量设置
   - CLPA说明

3. **记忆衰减速率** - 默认折叠
   - SCM、ELS、CLPA衰减速率

4. **AI 自动总结** - 默认折叠
   - 每日总结设置
   - AI总结配置
   - 总结长度

5. **AI API 配置** - 默认折叠
   - RimTalk配置优先级
   - 独立AI配置
   - 提供商选择

6. **记忆类型** - 默认折叠
   - 行动记忆开关
   - 对话记忆开关

### 2. UI特性

#### 可视化折叠状态
- **展开图标：** ▼ (Collapse)
- **折叠图标：** ▶ (Reveal)
- **深色背景：** 区分标题栏
- **点击切换：** 点击图标或标题区域

#### 布局优化
- 标题使用中等字体（GameFont.Medium）
- 区块之间有清晰的分隔线
- 折叠时只显示标题，节省空间
- 展开时显示完整内容

### 3. 常识库管理界面修复

#### 问题
标题"常识库管理"被工具栏按钮遮挡

#### 解决方案
- 标题位置：y=0
- 工具栏位置：y=40（原来y=40，与标题重叠）
- 搜索框位置：y=85（原来y=85）
- 增加了yPos变量动态计算位置
- 列表和详情区域自动调整高度

#### 新布局
```
y=0   : 标题 "常识库管理" (35px高度)
y=40  : 工具栏 (40px高度)
y=85  : 搜索框 + 统计 (30px高度)
y=120 : 列表 + 详情区域
```

---

## 使用方法

### 折叠/展开区块

**方式1：点击图标**
- 点击区块标题左侧的 ▼/▶ 图标

**方式2：点击标题区域**
- 点击整个标题栏都可以切换状态

### 默认状态

第一次打开设置时：
- ✅ **动态注入系统** - 展开（最常用）
- ⬜ **四层记忆容量** - 折叠
- ⬜ **记忆衰减速率** - 折叠
- ⬜ **AI 自动总结** - 折叠
- ⬜ **AI API 配置** - 折叠
- ⬜ **记忆类型** - 折叠

### 状态记忆

折叠状态在当前游戏会话中保持：
- 关闭设置窗口不会重置状态
- 重启游戏会恢复默认状态
- 不保存到存档文件

---

## 视觉效果

### 折叠状态示例
```
╔════════════════════════════════════╗
║ ▶ 动态注入系统                    ║
╠════════════════════════════════════╣
║ ▶ 四层记忆容量                    ║
╠════════════════════════════════════╣
║ ▶ 记忆衰减速率                    ║
╠════════════════════════════════════╣
```

### 展开状态示例
```
╔════════════════════════════════════╗
║ ▼ 动态注入系统                    ║
╠════════════════════════════════════╣
║   ☑ 启用动态记忆注入（推荐）      ║
║   最大注入记忆数: 10               ║
║   ████████████░░░░░░░░ (10)        ║
║   最大注入常识数: 5                ║
║   ███████░░░░░░░░░░░░░ (5)         ║
║                                    ║
║   评分权重配置:                    ║
║   时间衰减: 30%                    ║
║   重要性: 30%                      ║
║   关键词匹配: 40%                  ║
╠════════════════════════════════════╣
```

---

## 技术实现

### 折叠状态变量
```csharp
private static bool expandDynamicInjection = true;
private static bool expandMemoryCapacity = false;
private static bool expandDecayRates = false;
private static bool expandSummarization = false;
private static bool expandAIConfig = false;
private static bool expandMemoryTypes = false;
```

### 绘制可折叠区块
```csharp
DrawCollapsibleSection(
    listingStandard,
    "区块标题",
    ref expandVariable,
    () => DrawSectionContent(listingStandard)
);
```

### 区块组件
1. **标题栏**
   - 深色背景 (alpha=0.5)
   - 中等字体
   - 展开/折叠图标

2. **内容区**
   - 仅在展开时渲染
   - 调用专门的绘制方法
   - 自动缩进

3. **分隔线**
   - 区块之间的分隔
   - GapLine()

---

## 性能优化

### 条件渲染
- 折叠的区块不会渲染内容
- 只渲染可见的UI元素
- 减少DrawCall

### 状态管理
- 使用static变量存储状态
- 避免每帧重新计算
- 不污染存档数据

---

## 代码结构

### 新增方法

1. **DrawCollapsibleSection**
   - 通用折叠区块绘制
   - 处理展开/折叠逻辑
   - 渲染标题和图标

2. **DrawDynamicInjectionSettings**
   - 动态注入设置内容
   - 从原来的代码中提取

3. **DrawMemoryCapacitySettings**
   - 记忆容量设置内容

4. **DrawDecaySettings**
   - 衰减速率设置内容

5. **DrawSummarizationSettings**
   - 总结设置内容

6. **DrawAIConfigSettings**
   - AI配置设置内容

7. **DrawMemoryTypesSettings**
   - 记忆类型设置内容

### 修改的文件
- ✅ `Source\RimTalkSettings.cs` - 添加折叠功能
- ✅ `Source\Memory\UI\Dialog_CommonKnowledge.cs` - 修复标题位置

---

## 优势

### 用户体验
✅ 界面更整洁
✅ 减少滚动距离
✅ 快速找到需要的设置
✅ 新手友好（默认只展开核心设置）

### 可维护性
✅ 代码模块化
✅ 每个区块独立方法
✅ 易于添加新设置
✅ 易于调整布局

### 性能
✅ 减少渲染开销
✅ 按需渲染内容
✅ 状态持久化

---

## 未来改进

### 可选功能
- [ ] 保存折叠状态到配置文件
- [ ] 添加"全部展开/折叠"按钮
- [ ] 区块拖拽排序
- [ ] 搜索时自动展开相关区块
- [ ] 添加工具提示

### 可访问性
- [ ] 键盘导航支持
- [ ] 屏幕阅读器支持
- [ ] 高对比度主题

---

## 测试建议

### 功能测试
1. ✅ 点击图标能正确切换状态
2. ✅ 折叠后内容不显示
3. ✅ 展开后内容正确显示
4. ✅ 状态在会话中保持
5. ✅ 滚动条正常工作

### 视觉测试
1. ✅ 标题栏有深色背景
2. ✅ 图标正确显示
3. ✅ 字体大小合适
4. ✅ 间距合理
5. ✅ 分隔线清晰

### 常识库窗口测试
1. ✅ 标题不被遮挡
2. ✅ 工具栏位置正确
3. ✅ 搜索框对齐
4. ✅ 列表区域完整显示
5. ✅ 详情区域无裁剪

---

**构建状态：** ✅ 成功
**版本：** v2.1.0
