# 更新说明 - 调整注入数量下限

## 变更内容

### 调整了动态注入的最小值限制

**记忆注入数量**
- 旧限制：5-20条
- **新限制：1-20条**

**常识注入数量**
- 旧限制：3-10条
- **新限制：1-10条**

## 原因

降低最小值可以让用户有更灵活的配置选项：
- 对于简单对话，1-2条记忆可能已经足够
- 对于轻量使用，可以只注入1条常识作为基础设定
- 减少token消耗
- 提升性能（特别是在低配置环境）

## 常识注入确认

✅ **常识注入是动态的**

工作机制：
1. **提取上下文关键词** - 从对话内容中提取2-4字的关键词（最多20个）
2. **计算相关性分数** - 对每条常识计算：
   - 关键词匹配（Jaccard相似度）
   - 标签匹配
   - 重要性权重
3. **智能排序** - 按评分从高到低排序
4. **选择Top N** - 注入评分最高的N条常识

### 评分算法

```csharp
// 综合评分 = (关键词匹配 * 70% + 标签匹配) * 重要性
float score = (jaccardScore * 0.7f + tagScore) * importance;
```

### 示例

假设对话内容提到"食物短缺"：

**常识库内容：**
```
[世界观] 这是一个末日后的世界
[规则] 食物会腐坏，需要冷藏
[规则] 殖民者需要定期进食
[历史] 殖民地建立于三年前
[危机] 海盗会袭击殖民地
```

**动态注入结果：**（假设maxInjectedKnowledge=2）
```
## 背景常识

- [规则] 食物会腐坏，需要冷藏  (评分: 0.85)
- [规则] 殖民者需要定期进食    (评分: 0.72)
```

❌ 不会注入：
- [世界观] 这是一个末日后的世界 (评分: 0.15 - 无关键词匹配)
- [历史] 殖民地建立于三年前 (评分: 0.10 - 无关键词匹配)
- [危机] 海盗会袭击殖民地 (评分: 0.08 - 无关键词匹配)

## 使用建议

### 最小配置（性能优先）
```
最大注入记忆数: 1-3条
最大注入常识数: 1-2条
```
适合：
- 低配置电脑
- 简单对话场景
- 减少API消耗

### 推荐配置（平衡）
```
最大注入记忆数: 8-10条
最大注入常识数: 3-5条
```
适合：
- 大多数场景
- 一般对话深度

### 最大配置（深度对话）
```
最大注入记忆数: 15-20条
最大注入常识数: 8-10条
```
适合：
- 重要剧情对话
- 需要大量上下文
- 不在意token消耗

## 注意事项

⚠️ **即使设置为最小值1，也是动态的！**

设置为1时，系统会：
1. 计算所有记忆/常识的相关性分数
2. 选择评分**最高**的那一条
3. 注入到提示词中

这意味着即使只注入1条，也是最相关的那一条！

## Token消耗参考

假设每条记忆/常识平均20个token：

| 配置 | 记忆 | 常识 | 总计 | 备注 |
|------|------|------|------|------|
| 最小 | 1条(20) | 1条(20) | ~40 tokens | 极简模式 |
| 低 | 3条(60) | 2条(40) | ~100 tokens | 性能优先 |
| 中 | 8条(160) | 3条(60) | ~220 tokens | 推荐配置 |
| 高 | 10条(200) | 5条(100) | ~300 tokens | 标准配置 |
| 最大 | 20条(400) | 10条(200) | ~600 tokens | 深度对话 |

## 测试建议

1. **从小开始**
   - 先设置为1-2条
   - 观察对话质量
   - 逐步增加

2. **观察日志**
   - 开启DevMode
   - 查看注入的内容
   - 确认是否相关

3. **调整权重**
   - 如果注入的内容不够相关
   - 调整评分权重
   - 提高"关键词匹配"权重

---

**构建状态：** ✅ 成功
**版本：** v2.0.1
