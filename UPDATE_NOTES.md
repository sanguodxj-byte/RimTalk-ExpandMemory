# 更新说明 - 动态注入与常识库系统

## 🎉 主要更新

### 1. 动态记忆注入系统（类似酒馆）

**旧系统（静态注入）**
```
按固定顺序注入记忆：
- ABM全部
- SCM前5条
- ELS前5条
```

**新系统（动态注入）**
```
智能评分，选择最相关的记忆：
- 时间衰减：越新越重要
- 重要性：事件本身的权重
- 关键词匹配：与当前对话的相关性
- 综合评分排序，选Top 10
```

**优势**
✅ 更相关的记忆被优先注入
✅ 长期记忆也能在合适时候被唤起
✅ 减少无关信息的干扰
✅ 提升对话的连贯性和深度

### 2. 通用常识库系统

**功能**
- 📝 支持纯文本格式：`[标签]内容`
- 🔄 导入/导出功能
- ✏️ 可视化管理界面
- 🔍 智能相关性匹配
- ⚡ 动态注入到对话中

**用途**
- 世界观设定
- 游戏规则说明
- 角色背景信息
- 剧情相关常识
- 自定义设定

---

## 🚀 使用方法

### 启用动态注入

1. 打开Mod设置
2. 找到"动态注入系统"部分
3. 勾选"启用动态记忆注入（推荐）"
4. 调整配置（可选）：
   - 最大注入记忆数：10（推荐）
   - 最大注入常识数：5（推荐）
   - 评分权重：保持默认即可

### 管理常识库

1. **打开常识库管理**
   - Mod设置 → 常识库 → "打开常识库管理"
   - ⚠️ 需要在游戏中打开

2. **导入示例常识**
   - 查看 `KNOWLEDGE_EXAMPLES.md`
   - 复制需要的部分
   - 点击"导入"按钮
   - 粘贴文本
   - 确定

3. **管理常识**
   - 新建：添加新条目
   - 编辑：修改现有条目
   - 启用/禁用：复选框
   - 删除：移除不需要的条目
   - 导出：备份到文件

---

## ⚙️ 配置建议

### 不同场景的配置

#### 日常对话（推荐配置）
```
动态注入：✅ 启用
最大记忆数：8-10条
最大常识数：3-5条
时间衰减权重：35%
重要性权重：30%
关键词匹配：35%
```

#### 重要剧情
```
动态注入：✅ 启用
最大记忆数：12-15条
最大常识数：5-8条
时间衰减权重：25%
重要性权重：40%
关键词匹配：35%
```

#### 性能优先
```
动态注入：✅ 启用
最大记忆数：5-6条
最大常识数：2-3条
（权重保持默认）
```

#### 传统模式（不使用动态注入）
```
动态注入：❌ 禁用
将自动回退到静态注入
```

---

## 📊 效果对比

### 示例：对话场景

**对话内容**：John和Mary在讨论食物短缺问题

**旧系统（静态注入）**
```
注入的记忆：
1. [ABM] 刚才完成了清洁工作
2. [ABM] 心情不错
3. [SCM] 2小时前和Tom聊天
4. [SCM] 3小时前吃了一顿饭
5. [SCM] 5小时前建造了墙壁
```
❌ 只有第4条与食物相关

**新系统（动态注入）**
```
注入的记忆：
1. [SCM] 3小时前吃了简单餐食，不太美味（关键词：食物、餐）
2. [ELS] 昨天讨论过储备粮食的问题（关键词：食物、粮食）
3. [ELS] 2天前种植的作物还没成熟（关键词：作物、食物）
4. [CLPA] 上个月经历过饥荒（关键词：食物、短缺）
5. [ABM] 当前心情因饥饿下降（关键词：饥饿、心情）
```
✅ 所有记忆都高度相关！

---

## 🐛 故障排除

### 问题1：常识库按钮无法点击
**原因**：需要进入游戏后才能使用
**解决**：加载或新建一个存档

### 问题2：动态注入没有效果
**检查**：
1. 确认已启用动态注入
2. 查看DevMode日志
3. 确认小人有记忆组件

### 问题3：常识没有被注入
**原因**：相关性分数太低
**解决**：
1. 调整标签和关键词
2. 提高常识的重要性
3. 增加"最大注入常识数"

### 问题4：导入失败
**原因**：格式不正确
**解决**：
1. 确保格式为：`[标签]内容`
2. 每行一条
3. 不要有多余的空行或特殊字符

---

## 🔄 兼容性

### 与旧版本
✅ 完全兼容
✅ 可随时切换回静态注入
✅ 现有记忆数据不受影响

### 与RimTalk
✅ 自动patch RimTalk的对话生成
✅ 不需要额外配置
✅ 支持独立运行（不依赖RimTalk）

### 与其他Mod
✅ 不应该有冲突
✅ 如有问题请报告

---

## 📝 待办事项（未来更新）

- [ ] 改进中文分词算法
- [ ] 支持正则表达式匹配
- [ ] 常识库模板系统
- [ ] 批量编辑功能
- [ ] 常识使用统计
- [ ] 导入时自动去重

---

## 💡 使用技巧

1. **合理使用标签**
   - 标签应简短（2-4字）
   - 同类信息用相同标签
   - 避免过于泛化

2. **定期整理常识库**
   - 删除不再需要的条目
   - 合并相似的条目
   - 更新过时的信息

3. **观察日志**
   - 开启DevMode
   - 查看哪些记忆/常识被注入
   - 根据日志调整配置

4. **备份常识库**
   - 定期导出常识库
   - 保存到安全位置
   - 方便在不同存档间共享

---

## 🙏 反馈与建议

如有问题或建议，请：
1. 查看 `DYNAMIC_INJECTION_GUIDE.md` 详细文档
2. 查看 `KNOWLEDGE_EXAMPLES.md` 使用示例
3. 开启DevMode查看日志
4. 提交问题报告（附带日志）

---

**祝游戏愉快！** 🎮
