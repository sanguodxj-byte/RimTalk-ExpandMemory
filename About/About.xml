<?xml version="1.0" encoding="utf-8"?>
<ModMetaData>
	<packageId>sanguo.rimtalk.expandmemory</packageId>
	<name>RimTalk - Expand Memory</name>
	<author>SANGUO</author>
	<supportedVersions>
		<li>1.5</li>
		<li>1.6</li>
	</supportedVersions>
	<modVersion>3.3.15</modVersion>
	<url>https://github.com/sanguodxj-byte/RimTalk-ExpandMemory</url>
	
	<description>[h1]RimTalk - Expand Memory v3.3.15[/h1]

[b]🚀 四层记忆系统 + 智能注入 + 提示词规范化 + AI多平台支持[/b]

为RimTalk AI对话提供强大的记忆与常识支持，让殖民者拥有真实的记忆和知识！

[hr][/hr]

[h1]✨ 核心功能[/h1]

[b]🧠 四层记忆架构[/b]
超短期(ABM 6条) → 短期(SCM 10-50条) → 中期(ELS 20-100条) → 长期(CLPA 无限)，模拟真实的记忆衰减

[b]💬 玩家对话记录 (v3.3.15新增)[/b]
• 自动捕获玩家对角色说的话
• 直接存入ELS层，标记为高优先级(importance=0.8)
• 自动添加标签：玩家对话、直接记录、重要
• 角色能记住所有玩家说过的话

[b]🎯 智能动态注入[/b]
• 时间衰减30% + 重要性30% + 关键词40%
• 自动选择最相关记忆注入对话
• 名字识别加成：+0.3分（v3.3.2.38优化）
• 支持双角色关键词提取（当前角色 + 交互对象）
• O(1) LRU缓存优化

[b]🧹 自动清理系统[/b]
• Activity阈值清理：自动删除activity &lt; 0.01的"死亡"记忆
• ELS满时批量归档：归档最早25%记忆到CLPA（v3.3.15优化）
• 容量限制强制执行：超过上限时删除最低activity记忆
• 三重保护：固定记忆、用户编辑记忆、长期记忆永不删除

[b]✨ 提示词规范化 (v3.3.2.37)[/b]
• 用户自定义文本替换规则
• 支持正则表达式（忽略大小写）
• 预编译优化 + 20ms超时保护
• 实时生效，无需重启
• 示例：将 \(Player\) 替换为 Master

[b]📚 通用常识库[/b]
• 格式：[标签|重要性]内容
• 支持导入导出、角色专属、可视化UI
• 标签解析容错：[Noble] 和 [Noble} 都能识别（v3.3.2.38）
• 名字匹配智能识别：直接检测角色名字，+0.3加成
• 短关键词评分优化：2字关键词0.10分，3字关键词0.16分（v3.3.13）
• 旧版事件条目自动迁移（v3.3.15）

[b]⚡ SuperKeywordEngine[/b]
• 智能分词：中文2-6字词组 + 完整英文单词
• TF-IDF权重：长词优先，位置权重
• 完全确定性排序：相同输入总是相同输出（v3.3.2.34修复）
• 关键词上限：100个，响应时间 &lt;3ms

[b]🤖 AI 多平台支持[/b]
• OpenAI GPT、DeepSeek、Player2、Google Gemini、Custom
• Prompt Caching 节省50%费用
• 独立配置，不依赖RimTalk设置


[hr][/hr]

[h1]🎯 使用方法[/h1]

[b]基础配置[/b]
1. 安装 Harmony + RimTalk
2. 启用本Mod
3. Mod设置 → 打开常识库管理
4. 导入示例：
[code]
[世界观|0.9]边缘世界，科技倒退
[规则|0.8]回复80字内，口语化
[Noble|0.5]Noble是殖民地领袖，擅长社交
[/code]

[b]提示词规范化（v3.3.2.37）[/b]
1. Mod设置 → 顶部"提示词规范化"
2. 点击"+ 添加新规则"
3. 输入模式（正则表达式）：\(Player\)
4. 输入替换内容：Master
5. 勾选"启用"
6. 自动生效，无需重启

[b]AI 配置[/b]
1. Mod设置 → 展开"AI 配置"
2. 选择提供商（OpenAI/DeepSeek/Player2/Google/Custom）
3. 输入 API Key
4. 点击"验证配置"

[b]推荐配置[/b]
• 动态注入：启用 ✅
• 最大记忆：8-10条
• 最大常识：3-5条
• 记忆阈值：0.15
• 常识阈值：0.10

[b]调试工具[/b]
Mod设置 → 注入预览器 → 实时查看注入效果、评分明细、场景分析、关键词列表

[hr][/hr]

[h1]📊 性能优化[/h1]
[b]确定性行为：[/b]
• 关键词提取：完全确定性排序（长度降序 + 字母顺序）
• JSON解析：静态编译正则，10-20倍性能提升
• 纯数字检查：字符循环替代正则，100倍提升
• 对话缓存：O(1) LRU链表优化

[b]自动清理（v3.3.15增强）：[/b]
• Activity阈值清理：防止"死亡"记忆累积
• ELS批量归档：满时归档最早25%到CLPA
• 容量限制：强制执行SCM 20条、ELS 50条上限
• 保护机制：固定/编辑/长期记忆永不删除

[hr][/hr]

[h1]🔧 兼容性[/h1]
[b]必需：[/b]Harmony
[b]推荐：[/b]RimTalk（获得AI对话功能）
[b]加载顺序：[/b]Core → Harmony → RimTalk → 本Mod

[b]向后兼容：[/b]旧存档自动兼容

[hr][/hr]

[h1]📝 更新日志[/h1]

[b]v3.3.15 最新 🎉[/b]
• 💬 [b]玩家对话记录功能[/b]
  - 自动捕获玩家通过RimTalk对角色说的话
  - 直接存入ELS层（跳过ABM和SCM）
  - 高优先级标记（importance=0.8）
  - 自动添加标签：玩家对话、直接记录、重要
  - 角色能在未来对话中记住玩家说过的话
• 📚 [b]旧版事件条目迁移[/b]
  - 自动识别时间前缀（今天/N天前/约N天前）
  - 回填creationTick时间戳
  - 提取originalEventText原始文本
  - 支持的前缀：今天、1-6天前、约3-7天前
• 🛡️ [b]重复检测增强[/b]
  - 使用originalEventText进行精确匹配
  - 三重检查机制：精确匹配 → 模糊匹配 → 短文本完整匹配
  - 修复存档加载后时间前缀变化导致的重复记录
  - 示例修复：已存储"1天前..."，PlayLog重新生成"今天..." → 正确识别为已存在
• 🧹 [b]ELS归档优化[/b]
  - ELS满时批量归档最早25%记忆到CLPA（原逻辑：逐个移动）
  - 更高效的内存管理策略
  - 统一使用TrimEventLog方法管理容量

[b]v3.3.14[/b]
• 🧹 [b]记忆自动清理系统[/b]
  - Activity阈值清理：自动删除activity &lt; 0.01的"死亡"记忆
  - 容量限制强制执行：超过上限时删除最低activity记忆
  - 三重保护：固定记忆、用户编辑记忆、长期记忆永不删除
  - 每小时自动执行，防止记忆无限累积导致性能下降
  - DevMode下输出详细清理日志
• 📋 [b]完整文档[/b]
  - 新增 MEMORY_CLEANUP_SYSTEM.md 说明文档
  - 包含配置参数、测试用例、常见问题

[b]v3.3.13[/b]
• 🎯 [b]常识库评分优化[/b]
  - 提升2字关键词评分：0.05 → 0.10（+100%）
  - 提升3字关键词评分：0.12 → 0.16（+33%）
  - 优化完全匹配加成：支持2字和3字关键词
  - 修复短关键词常识无法匹配的问题
• 🎬 [b]场景分析显示[/b]
  - 预览器显示场景类型（战斗/社交/工作等）
  - 显示动态权重配置和场景特性
  - 帮助理解为什么某些记忆被选中或忽略
• 📝 [b]关键词列表显示[/b]
  - 预览器显示具体的上下文关键词
  - 按长度分组显示（6字、5字...1字）
  - 方便调试和验证关键词提取效果
• 📚 [b]诊断工具[/b]
  - 新增 KNOWLEDGE_SCORING_DIAGNOSTIC.md 诊断指南
  - 新增 PREVIEWER_GUIDE.md 预览器使用指南

[b]v3.3.2.38[/b]
• 🎯 [b]名字识别优化[/b]
  - 改进名字检测算法：直接检查角色名字列表
  - 支持双角色名字识别（当前角色 + 交互对象）
  - 名字匹配加成 +0.3 分
  - 详细调试日志：显示匹配的名字和加成详情
• 🛡️ [b]标签解析容错[/b]
  - 支持识别 [Noble} 格式（右括号写错为花括号）
  - 自动警告并修正格式错误
  - 提高常识库导入成功率

[b]v3.3.2.37[/b]
• ✨ [b]提示词规范化系统[/b]
  - 用户自定义替换规则
  - 支持正则表达式（预编译 + 超时保护）
  - 实时生效，无需重启
  - 完整的UI界面

[b]v3.3.2.36[/b]
• 🐛 [b]修复控制台崩溃[/b]
  - 移除 System.ValueTuple 依赖
  - 清理游戏目录中的冲突 DLL

[b]v3.3.2.34-v3.3.2.35[/b]
• 🚀 [b]性能优化大礼包[/b]
  - 关键词提取完全确定性
  - JSON解析 10-20倍提升
  - 纯数字检查 100倍提升
  - O(1) LRU缓存优化

[b]v3.3.2.31[/b]
• 🎯 名字关键词匹配加成（初版）

[b]v3.3.2.28[/b]
• 🚀 SuperKeywordEngine 重大优化
• ❌ 移除 VectorDB/语义嵌入/RAG

[hr][/hr]

[h1]🙏 鸣谢 Credits[/h1]

[b]Juicy - RimTalk 原作者 Original Author[/b]
RimTalk 是 RimWorld 最优秀的 AI 对话 Mod 之一，为殖民者赋予了真正的灵魂和个性。它的创新设计启发了我开发这个记忆系统扩展。
RimTalk is one of the best AI conversation mods for RimWorld, giving colonists real soul and personality. Its innovative design inspired me to create this memory system extension.

[b]GitHub Copilot (Claude Sonnet 4.5)[/b]
AI 辅助让开发更高效（我没有编写任何代码）
AI assistance made development more efficient. (I didn't write any code)

[hr][/hr]

GitHub: https://github.com/sanguodxj-byte/RimTalk-ExpandMemory

[b]让你的殖民者拥有真实记忆！[/b] 🎮
	</description>
	
	<modDependencies>
		<li>
			<packageId>brrainz.harmony</packageId>
			<displayName>Harmony</displayName>
			<steamWorkshopUrl>steam://url/CommunityFilePage/2009463077</steamWorkshopUrl>
		</li>
		<li>
			<packageId>cj.rimtalk</packageId>
			<displayName>RimTalk</displayName>
			<steamWorkshopUrl>https://steamcommunity.com/sharedfiles/filedetails/?id=3381946324</steamWorkshopUrl>
			<downloadUrl>https://github.com/CET-Chengdu/RimTalk</downloadUrl>
		</li>
	</modDependencies>
	
	<loadAfter>
		<li>brrainz.harmony</li>
		<li>cj.rimtalk</li>
		<li>Core40k.Core</li>
		<li>RH2.Faction.Astartes</li>
		<li>OGI.Core40k</li>
	</loadAfter>
	
	<incompatibleWith>
	</incompatibleWith>
</ModMetaData>