# RimWorld Mod 快速部署脚本示例
# 复制此文件为 deploy.ps1 并根据需要修改

param(
    [string]$RimWorldDir = $env:RIMWORLD_DIR,  # 从环境变量读取
    [string]$ModName = "RimTalk-MemoryPatch",
    [string]$GameVersion = "1.6"
)

$ErrorActionPreference = "Stop"

# 如果环境变量未设置，尝试从配置文件读取
if ([string]::IsNullOrEmpty($RimWorldDir)) {
    $configFile = Join-Path $PSScriptRoot ".rimworld.config"
    if (Test-Path $configFile) {
        $config = Get-Content $configFile | ConvertFrom-StringData
        $RimWorldDir = $config.RIMWORLD_DIR
    }
}

# 如果仍然为空，提示用户输入
if ([string]::IsNullOrEmpty($RimWorldDir)) {
    Write-Host "未找到 RimWorld 路径配置" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "请选择以下方式之一：" -ForegroundColor Cyan
    Write-Host "1. 创建 .rimworld.config 文件并填入路径（推荐）"
    Write-Host "2. 设置环境变量：setx RIMWORLD_DIR '您的路径'"
    Write-Host "3. 运行时指定路径：.\deploy.ps1 -RimWorldDir '您的路径'"
    Write-Host ""
    exit 1
}

# 颜色输出函数
function Write-ColorOutput($ForegroundColor) {
    $fc = $host.UI.RawUI.ForegroundColor
    $host.UI.RawUI.ForegroundColor = $ForegroundColor
    if ($args) {
        Write-Output $args
    }
    $host.UI.RawUI.ForegroundColor = $fc
}

Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  RimWorld Mod 部署工具" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# 检查 RimWorld 目录
if (-not (Test-Path $RimWorldDir)) {
    Write-Host "? 错误：找不到 RimWorld 目录" -ForegroundColor Red
    Write-Host "路径：$RimWorldDir" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "请检查：" -ForegroundColor Cyan
    Write-Host "1. .rimworld.config 文件中的 RIMWORLD_DIR 是否正确"
    Write-Host "2. 或者使用 -RimWorldDir 参数指定正确的路径"
    Write-Host ""
    exit 1
}

Write-Host "? RimWorld 目录：$RimWorldDir" -ForegroundColor Green

# 目标路径
$modPath = "$RimWorldDir\Mods\$ModName"
Write-Host "? Mod 目标路径：$modPath" -ForegroundColor Green
Write-Host ""

# 创建 Mod 目录
if (-not (Test-Path $modPath)) {
    New-Item -ItemType Directory -Path $modPath -Force | Out-Null
    Write-Host "? 已创建 Mod 目录" -ForegroundColor Green
}

# 复制文件夹
$folders = @("About", "Defs", "Languages", "Textures", $GameVersion)

foreach ($folder in $folders) {
    $source = Join-Path $PSScriptRoot $folder
    $dest = Join-Path $modPath $folder
    
    if (Test-Path $source) {
        Write-Host "正在复制 $folder..." -NoNewline
        
        # 使用 robocopy 镜像同步（Windows）
        if ($IsWindows -or $env:OS -eq "Windows_NT") {
            $result = robocopy $source $dest /MIR /NJH /NJS /NDL /NFL /NC /NS
            
            if ($LASTEXITCODE -le 7) {
                Write-Host " ?" -ForegroundColor Green
            } else {
                Write-Host " ?" -ForegroundColor Yellow
            }
        }
        # 使用 rsync（macOS/Linux）
        else {
            rsync -a --delete --checksum "$source/" "$dest/"
            if ($LASTEXITCODE -eq 0) {
                Write-Host " ?" -ForegroundColor Green
            } else {
                Write-Host " ?" -ForegroundColor Yellow
            }
        }
    } else {
        Write-Host "? 跳过 $folder（不存在）" -ForegroundColor Yellow
    }
}

Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  部署完成！" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Mod 已部署到：" -ForegroundColor Cyan
Write-Host $modPath -ForegroundColor Yellow
Write-Host ""
Write-Host "下一步：启动 RimWorld 并在 Mod 列表中启用 '$ModName'" -ForegroundColor Cyan
Write-Host ""
