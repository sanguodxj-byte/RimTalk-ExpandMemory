# 注入内容预览器 - 使用指南

## 简介

注入内容预览器是一个**实用的调试工具**，可以实时查看将要注入给AI的记忆和常识内容，无需复杂的拦截机制。

---

## 核心功能

✅ **实时预览** - 查看即将注入的确切内容  
✅ **详细评分** - 显示每条记忆/常识的评分明细  
✅ **模拟测试** - 输入对话主题测试关键词匹配  
✅ **殖民者选择** - 查看任意殖民者的注入内容  
✅ **统计信息** - 显示记忆和常识库的统计数据  

---

## 使用方法

### 1. 打开预览器

**进入游戏后：**
1. 加载任意存档
2. 打开Mod设置 → RimTalk-ExpandMemory
3. 滚动到"其他设置"
4. 点击**"打开注入内容预览器"**

### 2. 选择殖民者

- 点击殖民者名称下拉菜单
- 选择要查看的殖民者
- 预览器会自动刷新

### 3. 模拟对话主题（可选）

**测试关键词匹配：**
```
输入框：讨论食物短缺问题
点击：刷新预览
```

这会模拟在讨论"食物短缺"时，系统会注入哪些记忆和常识。

**留空则显示评分最高的内容**（不考虑特定主题）

### 4. 查看预览结果

预览器会显示：

```
【记忆注入内容】

动态选择了 8 条记忆（评分从高到低）：

[1] 评分: 0.85
    层级: Situational | 时间: 2.5小时前
    ├ 时间衰减: 0.28
    ├ 重要性: 0.24
    ├ 关键词: 0.30
    └ 加成: 0.03
    内容: 讨论了殖民地的食物储备不足问题

[2] 评分: 0.72
    ...

注入的完整文本：
--------------------------------
## 角色记忆

### 当前状态 (ABM)
- 刚才和John讨论了食物短缺问题

### 近期经历 (SCM)
- 2小时前：种植了土豆
...
--------------------------------

【常识注入内容】

动态选择了 3 条常识（评分从高到低）：

[1] 评分: 0.80
    标签: [规则]
    重要性: 0.7
    内容: 食物会腐坏，需要冷藏保存

[2] 评分: 0.65
    ...

注入的完整文本：
--------------------------------
## 背景常识

- [规则] 食物会腐坏，需要冷藏保存
- [规则] 殖民者需要定期进食
...
--------------------------------

总结：注入了 8 条记忆 + 3 条常识
```

---

## 界面说明

### 顶部统计栏

```
【记忆统计】
ABM: 2 | SCM: 15 | ELS: 45 | CLPA: 120

【常识库统计】
总数: 50 | 启用: 35

【注入配置】
模式: 动态 | 记忆: 10 | 常识: 5
```

### 中部控制区

```
模拟对话上下文（可选）：
┌─────────────────────────────────┐
│ 输入对话主题...                 │  [刷新预览]
└─────────────────────────────────┘
💡 输入对话主题可查看相关记忆，留空则显示评分最高的内容
```

### 底部预览区

滚动查看完整的注入内容，包括：
- 记忆评分明细
- 常识评分明细
- 最终注入的完整文本

---

## 实用场景

### 场景1：验证动态注入

**目的：** 确认动态注入是否正确工作

**步骤：**
1. 打开预览器
2. 输入："讨论粮食问题"
3. 查看注入的记忆
4. 确认是否包含相关内容（种植、烹饪、饥饿等）

**预期结果：**
- 评分高的记忆应该包含关键词"食物"、"粮食"、"饥饿"等
- 常识应该包含食物相关的规则

### 场景2：优化常识库

**目的：** 找出哪些常识从来不被使用

**步骤：**
1. 多次测试不同的对话主题
2. 记录每次注入的常识
3. 找出从未出现的常识
4. 删除或调整这些常识

**示例：**
```
测试主题：
- "讨论食物" → 注入了 [规则]食物腐坏
- "讨论战斗" → 注入了 [规则]武器使用
- "讨论心情" → 注入了 [世界观]末日环境

从未注入的：
- [历史]殖民地建立于五年前 ← 删除或降低重要性
```

### 场景3：调整权重

**目的：** 优化评分权重，提高相关性

**步骤：**
1. 测试一个主题，查看注入内容
2. 如果不相关的记忆评分太高：
   - 降低"时间衰减"权重
   - 提高"关键词匹配"权重
3. 重新测试，查看效果

**示例：**
```
问题：最近的无关记忆评分太高
原配置：时间30% | 重要性30% | 关键词40%
调整为：时间20% | 重要性20% | 关键词60%
结果：相关性明显提升
```

### 场景4：测试极端情况

**测试最少注入：**
```
设置：记忆=1，常识=1
输入："随便聊聊"
结果：只注入评分最高的1条记忆和1条常识
```

**测试最多注入：**
```
设置：记忆=20，常识=10
输入："详细讨论殖民地的历史"
结果：注入大量相关内容
```

### 场景5：对比静态vs动态

**静态注入：**
1. 关闭动态注入
2. 刷新预览
3. 查看按层级顺序的注入内容

**动态注入：**
1. 启用动态注入
2. 输入主题："讨论食物"
3. 查看智能选择的注入内容

**对比结果：**
- 静态：总是注入最新的记忆（可能无关）
- 动态：智能选择最相关的记忆

---

## 评分系统解析

### 记忆评分

```
总评分 = 时间衰减 + 重要性 + 关键词匹配 + 加成

时间衰减 = exp(-小时数/24) * 时间权重(30%)
  - 刚发生：1.0
  - 1天前：0.36
  - 3天前：0.05

重要性 = 记忆重要性 * 重要性权重(30%)
  - 范围：0.0-1.0
  - 用户编辑、固定：自动提高

关键词匹配 = Jaccard相似度 * 关键词权重(40%)
  - 完全匹配：1.0
  - 部分匹配：0.3-0.7
  - 无匹配：0.0

加成 = 层级加成 + 固定加成 + 编辑加成
  - ABM加成：+0.2
  - 固定记忆：+0.5
  - 用户编辑：+0.3
```

### 常识评分

```
评分 = (关键词相似度 * 0.7 + 标签匹配 * 0.3) * 重要性

关键词相似度：Jaccard(常识关键词, 对话关键词)
标签匹配：标签是否包含对话主题
重要性：0.1-1.0（可配置）
```

---

## 与AI拦截器的区别

| 特性 | AI拦截器（已移除） | 注入预览器（当前） |
|------|-------------------|-------------------|
| 实现方式 | Harmony拦截HTTP | 直接调用API |
| 异步支持 | ❌ 不支持 | ✅ 不需要 |
| 查看内容 | 实际发送的JSON | 模拟生成的内容 |
| 实时性 | 事后查看 | 事前预览 |
| 复杂度 | 高（需要拦截） | 低（直接调用） |
| 可靠性 | 低（技术限制） | 高（100%可用） |
| 测试功能 | ❌ 无 | ✅ 模拟主题 |

**结论：** 预览器更简单、更可靠、更实用！

---

## 常见问题

### Q1: 为什么显示"没有可注入的记忆"？

**可能原因：**
1. 殖民者是新角色，还没有记忆
2. 所有记忆的活跃度都衰减到0了
3. 关键词匹配分数都太低（<0.1）

**解决方法：**
- 让殖民者做些事情，产生新记忆
- 清空测试主题，查看评分最高的记忆
- 降低动态注入的过滤阈值

### Q2: 预览的内容和实际注入的一样吗？

**答：** 基本一样，但有细微差别

**相同：**
- 评分算法相同
- 选择逻辑相同
- 格式化相同

**差异：**
- 预览器使用模拟上下文
- 实际对话有真实的对话历史
- 实际注入可能包含额外的系统提示

### Q3: 能保存预览结果吗？

**答：** 目前不能

但你可以：
- 截图保存
- 复制文本（从滚动区域）
- 导出常识库（在常识库管理界面）

### Q4: 为什么有些记忆评分很高但没被注入？

**可能原因：**
1. 超过了最大注入数量限制
2. 被更高分的记忆挤掉了
3. 在其他层级中（如CLPA默认不注入）

**检查：**
- 查看"最大注入记忆数"设置
- 对比所有记忆的评分
- 确认是否包含归档记忆

### Q5: 测试主题输入什么好？

**建议：**

**具体主题：**
- "讨论食物问题"
- "战斗经历"
- "心情不好"
- "殖民地的未来"

**泛泛主题：**
- "闲聊"
- "随便聊聊"
- 留空

**测试极端：**
- "xyzabc"（无意义词，测试无匹配情况）
- 复制一长串常识内容（测试完全匹配）

---

## 性能影响

**几乎为零！**

- 只在点击"刷新预览"时运行
- 不影响游戏性能
- 不消耗API调用
- 不保存历史数据

---

## 开发者信息

### API接口

```csharp
// 获取带评分的记忆
string injected = DynamicMemoryInjection.InjectMemoriesWithDetails(
    memoryComp, 
    context, 
    maxCount,
    out List<MemoryScore> scores
);

// 获取带评分的常识
string injected = library.InjectKnowledgeWithDetails(
    context, 
    maxCount,
    out List<KnowledgeScore> scores
);
```

### 数据结构

```csharp
public class MemoryScore
{
    public MemoryEntry Memory;
    public float TotalScore;
    public float TimeScore;
    public float ImportanceScore;
    public float KeywordScore;
    public float BonusScore;
}

public class KnowledgeScore
{
    public CommonKnowledgeEntry Entry;
    public float Score;
}
```

---

## 最佳实践

### 1. 定期检查

- 每周测试一次主要对话主题
- 确认注入内容符合预期
- 调整权重和配置

### 2. 对比测试

- 测试前后对比（修改配置前后）
- 多个殖民者对比（谁的记忆更丰富）
- 不同主题对比（食物vs战斗）

### 3. 优化流程

```
1. 打开预览器
2. 测试3-5个典型主题
3. 记录不合理的注入
4. 调整配置（权重/常识/容量）
5. 重新测试
6. 重复直到满意
```

### 4. 文档记录

记录你的优化过程：
```
日期：2024-01-15
主题：食物讨论
问题：注入了无关的战斗记忆
原因：时间权重太高
调整：时间30%→20%，关键词40%→60%
结果：✅ 相关性提升
```

---

## 总结

注入内容预览器是一个**简单、可靠、实用**的工具：

✅ **无需复杂配置** - 开箱即用  
✅ **100%可靠** - 不依赖拦截  
✅ **功能强大** - 详细评分、模拟测试  
✅ **易于使用** - 直观的界面  

**相比之前的AI拦截器：**
- 更简单（不需要Harmony拦截）
- 更可靠（没有异步限制）
- 更实用（可以主动测试）
- 更快速（即时响应）

**推荐所有用户使用此工具优化记忆注入效果！**

---

**构建状态：** ✅ 成功  
**版本：** v2.3.0  
**替代：** AI请求拦截器（已移除）
