# ? 部署清单 - v3.3.2.7

## ?? **已部署文件**

### **1. 程序集（DLL）**
- ? `D:\steam\steamapps\common\RimWorld\Mods\RimTalk-ExpandMemory\1.6\Assemblies\RimTalkMemoryPatch.dll`
  - **版本：** v3.3.2.7
  - **大小：** ~（编译后大小）
  - **状态：** 已更新

### **2. Mod元数据**
- ? `D:\steam\steamapps\common\RimWorld\Mods\RimTalk-ExpandMemory\About\About.xml`
  - **版本号：** 3.3.2.7
  - **更新日志：** 已添加
  - **状态：** 已更新

---

## ?? **修复内容总结**

### **修复1：RAG降级检索添加常识库**
- **文件：** `RAGManager.cs`
- **方法：** `FallbackRetrieve()`
- **功能：** 降级检索现在包含常识（重要性>=0.7，最多20条）
- **性能影响：** <6ms（可接受）

### **修复2：提升默认重要性**
- **文件：** `Dialog_CommonKnowledge.cs`
- **方法：** `ParseLineForVectorDB()`
- **变更：** 0.5 → 0.7
- **影响：** 手动注入的常识更容易被检索

### **修复3：格式化文本判断BUG**
- **文件：** `Dialog_CommonKnowledge.cs`
- **方法：** `IsFormattedText()`
- **问题：** 多余的分号
- **修复：** 已移除
- **影响：** 恢复正确判断逻辑

---

## ?? **解决的问题**

### **问题：伊什穆蒂特常识无法被注入**
**原因：**
1. ? RAG降级检索不包含常识库
2. ? 默认重要性0.5低于阈值0.7
3. ? 格式化文本判断逻辑错误

**解决方案：**
1. ? 降级检索添加常识库检索
2. ? 默认重要性提升到0.7
3. ? 修复判断逻辑BUG

**验证：**
```
[伊什穆蒂特]内容...  ← 现在使用重要性0.7 ?
[伊什穆蒂特|0.8]内容... ← 用户指定重要性 ?
```

---

## ?? **测试检查清单**

### **启动前检查**
- [x] DLL已部署到正确位置
- [x] About.xml已更新版本号
- [x] 游戏已关闭

### **启动后检查**
- [ ] 游戏正常启动
- [ ] Mod列表中显示v3.3.2.7
- [ ] 无红色错误提示

### **功能测试**
- [ ] **测试1：** 手动注入常识（无重要性标记）
  ```
  [测试]这是测试常识
  ```
  预期：重要性=0.7 ?

- [ ] **测试2：** 触发对话，检查日志
  ```
  [RAG Manager] Fallback: X memories, Y knowledge
  ```
  预期：Y > 0 ?

- [ ] **测试3：** 伊什穆蒂特常识
  ```
  [伊什穆蒂特|0.8]人工种族...
  ```
  预期：被降级检索选中 ?

### **性能测试**
- [ ] 对话触发无卡顿
- [ ] FPS稳定
- [ ] 日志无性能警告

---

## ?? **版本对比**

| 功能 | v3.3.2.6 | v3.3.2.7 |
|------|---------|---------|
| **降级检索常识** | ? 无 | ? 有（>=0.7） |
| **默认重要性** | 0.5 | **0.7** |
| **格式判断** | ? BUG | ? 正常 |
| **性能** | 快 | 快（<6ms） |

---

## ?? **用户指南**

### **推荐的常识格式**

#### **格式1：带重要性标记（推荐）**
```
[伊什穆蒂特|0.8]人工种族的统称，全女性人造种族...
[Agatha|0.8]是伊什穆蒂特中的混沌灵・阿瓦露琪安...
```

#### **格式2：使用默认重要性**
```
[伊什穆蒂特]人工种族的统称...
[Agatha]是伊什穆蒂特中的混沌灵...
```
自动使用重要性=0.7

#### **格式3：纯文本（自动分段）**
```
这是边缘世界
科技已经倒退
海盗经常袭击
```
每行重要性=0.7

### **重要性建议**

| 常识类型 | 推荐重要性 | 说明 |
|---------|----------|------|
| **核心世界观** | 0.9-1.0 | 必须注入 |
| **角色背景** | 0.8-0.9 | 高优先级 |
| **规则/约束** | 0.8-0.9 | 高优先级 |
| **一般知识** | 0.7-0.8 | 标准 |
| **备注/杂项** | 0.5-0.7 | 低优先级 |

---

## ?? **启动指令**

### **Windows**
```batch
1. 关闭游戏（如果在运行）
2. 启动 RimWorld
3. 启用 Mod: RimTalk-ExpandMemory
4. 加载存档或创建新游戏
```

### **验证部署**
```
1. 打开游戏
2. 查看Mod列表
3. 确认版本显示为 v3.3.2.7
4. 进入游戏测试对话
```

---

## ?? **故障排除**

### **问题1：常识仍未被注入**
**检查：**
1. 常识重要性是否>=0.7？
2. 日志中是否显示`Fallback: X memories, Y knowledge`？
3. `Y`是否>0？

**解决：**
- 提高常识重要性到0.8
- 检查RAG是否启用（设置中）
- 查看日志中的错误信息

### **问题2：格式化文本无法识别**
**检查：**
1. 是否每行都以`[标签]`开头？
2. 是否包含`]`结束标记？

**正确格式：**
```
[标签]内容  ?
[标签|0.8]内容  ?
标签内容  ?（无格式）
```

### **问题3：性能下降/卡顿**
**检查：**
1. 常识库是否过大（>200条）？
2. 日志中是否有性能警告？

**解决：**
- 清理低重要性常识（<0.7）
- 提高降级检索阈值到0.8
- 禁用部分实验性功能

---

## ? **部署完成确认**

- [x] **编译成功** - 无错误无警告
- [x] **DLL已部署** - v3.3.2.7
- [x] **About.xml已更新** - 版本号+日志
- [x] **文档已创建** - 部署报告、修复说明
- [x] **准备测试** - 等待游戏启动

---

## ?? **部署状态：完成**

**? v3.3.2.7 已成功部署到游戏目录！**

**下一步：**
1. 重启RimWorld
2. 加载存档
3. 测试伊什穆蒂特常识注入
4. 检查日志验证修复

**预期结果：**
```
[RAG Manager] Fallback: 14 memories, 3 knowledge (high-importance only)
[Smart Injection] Injected 14 memories, 3 knowledge
```

**?? 现在可以启动游戏测试了！** ??
